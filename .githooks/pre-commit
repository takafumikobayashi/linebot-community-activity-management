#!/usr/bin/env bash
set -eo pipefail

# A simple pre-commit hook to prevent committing OpenAI API keys.

# Color codes
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Allow bypassing the hook
if [[ "${LEAK_BYPASS:-0}" == "1" ]]; then
  echo -e "${YELLOW}WARNING: Bypassing pre-commit secret scan.${NC}"
  exit 0
fi

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
  exit 0
fi

echo "Running pre-commit hook: Checking for OpenAI keys..."

# OpenAI key pattern
PATTERN="sk-[a-zA-Z0-9]{20,}"

for FILE in $STAGED_FILES; do
  if grep -E -q "$PATTERN" "$FILE"; then
    echo -e "${RED}Error: Potential OpenAI API key found in file: $FILE${NC}"
    echo -e "${RED}Please remove the key before committing.${NC}"
    echo -e "${YELLOW}To bypass this check (not recommended), run:${NC}"
    echo -e "${YELLOW}LEAK_BYPASS=1 git commit ...${NC}"
    exit 1
  fi
done

echo "  Scan complete. No keys found."
exit 0
